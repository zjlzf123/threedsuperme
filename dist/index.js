!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("jszip")):"function"==typeof define&&define.amd?define(["jszip"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).threedsuperme=t(e.JSZip)}(this,(function(e){"use strict";function t(e,t,r,n){return new(r||(r=Promise))((function(o,a){function i(e){try{s(n.next(e))}catch(e){a(e)}}function u(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,u)}s((n=n.apply(e,t||[])).next())}))}function r(e,t){var r,n,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(u){return function(s){return function(u){if(r)throw new TypeError("Generator is already executing.");for(;a&&(a=0,u[0]&&(i=0)),i;)try{if(r=1,n&&(o=2&u[0]?n.return:u[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,u[1])).done)return o;switch(n=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return i.label++,{value:u[1],done:!1};case 5:i.label++,n=u[1],u=[0];continue;case 7:u=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){i=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){i.label=u[1];break}if(6===u[0]&&i.label<o[1]){i.label=o[1],o=u;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(u);break}o[2]&&i.ops.pop(),i.trys.pop();continue}u=t.call(e,i)}catch(e){u=[6,e],n=0}finally{r=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,s])}}}function n(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function o(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,a=r.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(n=a.next()).done;)i.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(o)throw o.error}}return i}var a=function(){function t(e,t){this.token=e,this._auth_header="Bearer "+e,this.base_url=t,this._x_user_agent="asdk.js/0.2 ("+window.location.host+")"}return t.prototype._url=function(e){return new URL(e,this.base_url)},t.prototype._performRequest=function(e,t){void 0===t&&(t={});var r=t.headers||{};return r.Authorization=this._auth_header,r["X-User-Agent"]=this._x_user_agent,t.headers=r,fetch(e,t)},t.prototype._jsonResponse=function(e){return new Promise((function(t,r){e.then((function(e){return e.ok?e.json().then(t):e.json().then((function(e){return r(e)})).catch((function(){return r(e)}))}))}))},t.prototype.get_available_parameters=function(e,t){var r=this._url("/parameters/available/"+e+"/");return r.searchParams.append("pipeline_subtype",t),this._jsonResponse(this._performRequest(r))},t.prototype.get_available_export_parameters=function(e,t){var r=this._url("/export_parameters/available/"+e+"/");return r.searchParams.append("pipeline_subtype",t),this._jsonResponse(this._performRequest(r))},t.prototype.create_avatar=function(e,t,r,n,o,a){var i=new FormData;i.append("name",e),i.append("photo",t,t.name),i.append("pipeline",r),i.append("pipeline_subtype",n),i.append("parameters",o),i.append("export_parameters",a);var u=this._url("/avatars/");return this._jsonResponse(this._performRequest(u,{method:"POST",body:i}))},t.prototype.get_avatar=function(e){var t=e.url;return this._jsonResponse(this._performRequest(t))},t.prototype._poll_impl=function(e,t,r,n,o){this.get_avatar(e).then((function(e){var a=e.status;switch(n&&n(e),a){case"Completed":return clearInterval(o()),t(e);case"Failed":case"Timed Out":return clearInterval(o()),r(e);case"Pending":case"Uploading":case"Queued":case"Computing":break;default:console.log('unknown status "%s"',a)}})).catch((function(e){return console.log(e),clearInterval(o()),r(e)}))},t.prototype.poll_avatar=function(e,t){var r=this;return new Promise((function(n,o){var a=null;a=setInterval(r._poll_impl.bind(r),5e3,e,n,o,t,(function(){return a}))}))},t.prototype.get_exports=function(e){var t=e.exports;return this._jsonResponse(this._performRequest(t))},t.prototype.poll_export=function(e,t){var r=this;return new Promise((function(n,o){var a=null;a=setInterval(r._poll_impl.bind(r),5e3,e,n,o,t,(function(){return a}))}))},t.prototype.download_export_file=function(e,t,r){if(void 0===r&&(r=!1),r)return this._performRequest(e).then((function(e){return e.blob()})).then((function(e){var r=new File([e],t,{type:e.type});return URL.createObjectURL(r)}));var n=new URL(e);return n.searchParams.append("access_token",this.token),Promise.resolve(n)},t.prototype._extractZipFiles=function(t){return e.loadAsync(t).then((function(e){var t,r,o=[],a=function(e){if(e.dir)return"continue";var t=e.name.split("/");t=t[t.length-1];var r=e.async("blob").then((function(e){var r={};return r[t]=e,r}));o.push(r)};try{for(var i=n(Object.values(e.files)),u=i.next();!u.done;u=i.next()){a(u.value)}}catch(e){t={error:e}}finally{try{u&&!u.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}return Promise.all(o).then((function(e){return e.reduce((function(e,t){return Object.assign(e,t),e}),{})}))}))},t.prototype.get_export_file_contents=function(e,t){var r=this,n=e.file;return this._performRequest(n).then((function(e){if(!e.ok)throw Error(e.status+" "+e.statusText);if(!e.body)throw Error("ReadableStream not yet supported in this browser.");var r=e.headers.get("content-encoding"),n=e.headers.get(r?"x-file-size":"content-length");if(null===n)throw Error("Response size header unavailable");var o=parseInt(n,10),a=0;return new Response(new ReadableStream({start:function(r){var n=e.body.getReader();!function e(){n.read().then((function(n){var i=n.done,u=n.value;if(i)r.close();else{a+=u.byteLength;var s=Math.round(100*a/o);t&&t("Downloading",s),r.enqueue(u),e()}})).catch((function(e){console.error(e),r.error(e)}))}()}}))})).then((function(e){return e.blob()})).then((function(e){return t&&t("Processing"),r._extractZipFiles(e)}))},t}();function i(e){return e.split("|").map((function(e){return e.trim()}))}function u(){return Math.round(Date.now()/1e3)}function s(e){return JSON.parse(JSON.stringify(e))}function l(e){return{red:e.r,green:e.g,blue:e.b}}function c(e,t,r){return t in e||(e[t]=r),e[t]}var f="head_1.2 | base/static";function p(){return t(this,void 0,void 0,(function(){var e,t,n,o;return r(this,(function(r){if(e=localStorage.getItem("access_token"),console.log("1234567"),e){if(e=JSON.parse(e),!(u()>=e.expires-300))return[2,e.access_token];localStorage.removeItem("access_token")}return t="Basic "+btoa("wl9sluOVVNMHtdyqOWnERP5RgukcKPbJUebgJJxe:6WBxXOq3lghNyDGadIuf2BzX9harUrO1RMd6sQ05NYBJAldm0EsywuT47k9IiaEaqE0RMRILumTv0ygN3ZVfpoiyoYkW4LHfhp3lmmJkN3mMIZJkP9aMUOCmjuIgeUM5"),n={Authorization:t},(o=new FormData).append("grant_type","client_credentials"),[2,fetch("https://avatar-api.itseez3d.com/o/token/",{headers:n,method:"POST",body:o}).then((function(e){return e.json()})).then((function(e){return e.expires=u()+e.expires_in,localStorage.setItem("access_token",JSON.stringify(e)),e.access_token}))]}))}))}function h(e){return t(this,void 0,void 0,(function(){var t,n,u,s,l,c;return r(this,(function(r){return t=new a(e,"https://avatar-api.itseez3d.com/"),n=o(i(f),2),u=n[0],s=n[1],l=t.get_available_parameters(u,s),c=t.get_available_export_parameters(u,s),[2,Promise.all([l,c]).then((function(e){var r=o(e,2),n=r[0];return n=function(e,t){var r=Object.keys(e);return r.length?(r=r[0],Object.keys(t).forEach((function(t){e[r].hasOwnProperty(t)&&delete e[r][t]})),e):e}(n,r[1]),{parameters:n,asdk:t}}))]}))}))}function d(e,a,u,p,d,v){return void 0===u&&(u="fileBlob"),t(this,void 0,void 0,(function(){var t,y,_,b,m,g,x,w;return r(this,(function(r){switch(r.label){case 0:return[4,h(a)];case 1:return t=r.sent().asdk,y=JSON.stringify({}),_=o(i(f),2),b=_[0],m=_[1],g=function(e){var t=function(e){switch(e){case"as avatar":return null;case"true":return!0;case"false":return!1}return s(e)},r=function(e){var a,i,u,c={};try{for(var f=n(Object.entries(e)),p=f.next();!p.done;p=f.next()){var h=o(p.value,2),d=h[0],v=h[1];switch(d){case"format":case"embed":case"pointclouds":case"embed_textures":if(null===(y=t(v)))continue;c[d]=y;break;case"additional_textures":case"list":if(0===(u=v,y=Object.entries(u).reduce((function(e,t){return!0===t[1]&&e.push(t[0]),e}),[])).length)continue;c[d]=y;break;case"lod":case"color":case"texture_size":if(!v.enabled)continue;var y=v.value;y="color"===d?l(y):s(y),c[d]=y;break;case"haircuts":case"outfits":case"blendshapes":if(y=r(v),0===Object.keys(y).length)continue;c[d]=y;break;case"_allNone":break;default:console.log('unknown key "%s"',d)}}}catch(e){a={error:e}}finally{try{p&&!p.done&&(i=f.return)&&i.call(f)}finally{if(a)throw a.error}}return c};return r(e)}({format:"obj",embed:!0,pointclouds:!1,additional_textures:{roughness_map:!1,metallic_map:!1,lips_mask:!1},embed_textures:!1,texture_size:{enabled:!1,value:{width:0,height:0}},lod:{enabled:!1,value:0}}),x=function(e){var t,r,o,a,i={format:"glb",embed:!0,embed_textures:!0},u=["lod","texture_size","color"];try{for(var s=n(["","haircuts","outfits"]),l=s.next();!l.done;l=s.next()){var f=l.value,p=e,h=i;if(f){if(void 0===(p=null==e?void 0:e[f]))continue;h=c(i,f,{});var d=p.list;d&&d.length>0&&(h.list=[d[0]])}try{for(var v=(o=void 0,n(u)),y=v.next();!y.done;y=v.next()){var _=y.value,b=null==p?void 0:p[_];void 0!==b&&(h[_]=b)}}catch(e){o={error:e}}finally{try{y&&!y.done&&(a=v.return)&&a.call(v)}finally{if(o)throw o.error}}}}catch(e){t={error:e}}finally{try{l&&!l.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}return i}(g),g=JSON.stringify([x,g]),w=function(e){p&&p(e)},t.create_avatar("test",e,b,m,y,g).then((function(e){return t.poll_avatar(e,w)})).then((function(e){return t.get_exports(e)})).then((function(e){return function(e,t,r){if(void 0===r&&(r=0),!(r>e.length)){e.length>1&&e.sort((function(e,t){return function(e,t){return e>t?1:e<t?-1:0}(e.created_on,t.created_on)}));var n=e[r];return"Completed"===n.status?Promise.resolve(n):t.poll_export(n)}}(e,t)})).then((function(e){var r,a,i,s,l,f;if("fileBlob"===u){var p=void 0;try{for(var h=n(e.files),y=h.next();!y.done;y=h.next()){var _=y.value;if("avatar"===_.identity){p=_;break}}}catch(e){r={error:e}}finally{try{y&&!y.done&&(a=h.return)&&a.call(h)}finally{if(r)throw r.error}}t.get_export_file_contents(p,(function(e,t){d&&d({stage:e,pct:t})})).then((function(e){v&&v(e)}))}else{var b=e.files.reduce((function(e,t){var r=t.category||"avatar",n=t.identity;return c(e,r,{})[n]=t,e}),{});try{for(var m=n(Object.entries(b)),g=m.next();!g.done;g=m.next()){var x=o(g.value,2),w=(x[0],x[1]);try{for(var k=(l=void 0,n(Object.entries(w))),R=k.next();!R.done;R=k.next()){var j=o(R.value,2),O=(j[0],j[1].file),P=O.split("/");P=P[P.length-1],t.download_export_file(O,P,!1).then((function(e){v&&v(e)})).catch((function(e){console.error(e)}))}}catch(e){l={error:e}}finally{try{R&&!R.done&&(f=k.return)&&f.call(k)}finally{if(l)throw l.error}}}}catch(e){i={error:e}}finally{try{g&&!g.done&&(s=m.return)&&s.call(m)}finally{if(i)throw i.error}}}})).catch((function(e){console.error("catch error:",e)})),[2]}}))}))}return function(e,n){var o=n.returnDataType,a=n.onCompletedProgress,i=n.onExportProgress,u=n.callback;return t(this,void 0,void 0,(function(){var t;return r(this,(function(r){switch(r.label){case 0:return[4,p()];case 1:return t=r.sent(),[4,d(e,t,o,a,i,u)];case 2:return[2,r.sent()]}}))}))}}));
